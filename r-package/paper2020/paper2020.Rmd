---
title: 'r5r: rapid realistic routing on multimodal transport networks with R5 in R'
author: "Rafael H. M. Pereira, Marcus Saraiva, Daniel Herszenhut, Carlos Kaue Braga, Matthew Wigginton Conway"
date: "`r Sys.Date()`"
output:
   html_document: default
   word_document: default
   pdf_document: default
abstract: Routing is a key step in transport planning and research. Nonetheless, researchers and practitioners often face challenges to perform this task due to the cost of licensed software and long computation times. Conveyal’s R<sup>5</sup> is a multimodal transport network router that offers multiple planning features, such as calculating travel times over a time window, and returning multiple itineraries for origin/destination pairs. This paper describes r5r, an open-source R package that leverages on R<sup>5</sup> to allow users to efficiently compute travel time matrices and generate detailed itineraries between sets of origins and destinations at no expense using seamless parallel computing.
urlcolor: blue
bibliography: references.json
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7, 
  fig.height = 5
)

set.seed(0)
```

<!-- Examples of similar papers -->

<!--  - https://transportfindings.org/article/8416-accessibility-toolbox-for-r-and-arcgis -->

<!--  - https://transportfindings.org/article/6945-dodgr-an-r-package-for-network-flow-aggregation -->

<!--  - https://joss.theoj.org/papers/10.21105/joss.01926 -->

# RESEARCH QUESTIONS AND HYPOTHESES

Transport routing is the process of finding the alternative routes and costs that connect places on a given transport network, and it is a key step in transport accessibility analysis, fleet allocation and transport simulation and planning more broadly [@levinson2020manual]. Researchers and practitioners still frequently face practical challenges when carrying out routing analysis tasks due to the monetary costs of licensed software, limited data availability for data hungry models, and the long computation times required to run multiple routing scenarios, particularly in large and complex multimodal transport networks.

While there is a growing number of open source routing models [@opentripplanneropentripplanner; @lovelace2019stplanr; @padgham2019dodgr], most options available do not efficiently process large transport networks. This paper presents [r5r](https://ipeagit.github.io/r5r/), a new open source R package for routing on multimodal transport networks based on the [Rapid Realistic Routing on Real-world and Reimagined networks (R<sup>5</sup>)](https://github.com/conveyal/r5). R<sup>5</sup> is a powerful next-generation routing engine written in Java and developed at Conveyal [@conway2017evidencebased; @conway2018accounting] to provide an efficient backend for analytic applications - such as accessibility analysis. The r5r package provides a simple and friendly interface to run R<sup>5</sup> locally from within R, which allows users to efficiently calculate travel time matrices or generate multiple route alternatives between origins and destinations using seamless parallel computing.

<!-- More importantly, those tools generate deterministic estimates of travel times without accounting for variability in results (due to service reliability issues, for example) ... [rafa: the idea here is to emphasize the power of R5 with the time_window parameter. We certainly need to rephrase things, but perhaps we should stress this idea here -->

# METHODS AND DATA

The r5r package has low data requirements and is easily scalable, allowing fast computation of routes and travel times at either city or country-level analysis. It creates a routable transport network using street network data from [OpenStreetMap](https://www.openstreetmap.org/) (OSM), and it automatically combines public transport data if they are provided by the user in the standard [General Transit Feed Specification](https://developers.google.com/transit/gtfs/) (GTFS) format.

The r5r package has 3 fundamental functions:

-   `setup_r5()`: builds a multimodal transport network used for routing in R<sup>5</sup>. This function automatically (1) downloads/updates a compiled R<sup>5</sup> JAR file and stores it locally for future use; and (2) combines the OSM and GTFS datasets to build a routable network object.

-   `travel_time_matrix()`: computes travel time estimates between one or multiple origin/destination pairs for a single departure time or for multiple departure times over a `time_window` set by the user. This function uses an R5-specific extension to the RAPTOR routing algorithm which provides an efficient and systematic sampling of multiple simulated schedules when using frequency-based GTFS data [@conway2017evidencebased].

<!-- If the user passes a `time_window` parameter to the function, r5r calculates multiple travel time matrices departing each minute and returns additional information on the percentile distribution of travel times that allows one to grasp service reliability issues. -->

-   `detailed_itineraries()`: computes detailed information on either the shortest or multiple alternative routes between one or multiple origin/destination pairs for a single departure time. The output includes detailed information on route alternatives such as the transport mode, waiting time, travel time and distance of each segment of the trip. This function uses an R5-specific extension[^1] to the McRAPTOR [@delling2015roundbased] routing algorithm to find optimal or less than optimal paths.

[^1]: The specific extension to McRAPTOR to do suboptimal path routing is not documented yet.

Both routing functions are versatile so users can easily set customized inputs such as transport modes, departure date and times, walking and cycling speeds, maximum trip duration, walking distances and number of public transport transfers. In the following section, we will focus on results obtained from `travel_time_matrix()`.

# FINDINGS

After installed with the `install.packages("r5r")` command, the package can be attached (alongside some other packages to reproduce this article), as follows:

```{r, message = FALSE, warning = FALSE}
library(r5r)
library(sf)
library(data.table)
library(ggplot2)
library(akima)
```

The package includes sample datasets for the cities of São Paulo and Porto Alegre (both in Brazil). Each dataset includes:

-   An OSM network in `.pbf` format.
-   A public transport network in `GTFS.zip` format.
-   The spatial coordinates of points covering the area in `.csv` format.

### Building a routable transport network

To build a routable transport network with r5r and load it in memory, the user need to run a command line pointing to the location on disk where the input data is stored. In the examples of this paper, we will be using the provided Porto Alegre dataset.

```{r, message = FALSE}
# points to directory with data
data_path <- system.file("extdata/poa", package = "r5r")

r5r_core <- setup_r5(data_path, verbose = FALSE)
```

The function uses the `.pbf` and the `GTFS.zip` files in the directory pointed by `data_path` to create a multimodal transport network used for routing by R<sup>5</sup>. Multiple GTFS feeds can be used simultaneously, in which case R<sup>5</sup> will automatically merge all files into a single public transport network. The resulting `network.dat` as well as some other files used by R<sup>5</sup> are saved inside the supplied directory for later reuse.

### Calculating a travel time matrix

The `travel_time_matrix()` function takes, as inputs, the spatial location of origins/destinations (either as a spatial `sf POINT` object, or as a `data.frame` containing the columns `id`, `lon` and `lat`) and a few travel parameters such as *maximum trip duration* or *walking distance*. It outputs travel time estimates for each origin-destination pair at a set `departure_datetime`.

Since service levels can significantly vary across the day [@stepniak2019impact], users can account for this variation using the `time_window` parameter. In this case, several matrices are calculated using every minute within the set time window as a departure time. By default the function outputs the 50th percentile (i.e. the median) travel time between each origin and destination pair within the time window. The `percentiles` parameter allows the user to retrieve travel time estimates at different points of the distribution. An example of the function's usage is presented below:

```{r, message = FALSE}
# read points of origin and destination
points <- fread(file.path(data_path, "poa_hexgrid.csv"))

# routing inputs
mode <- c("WALK", "TRANSIT")
max_walk_dist <- 1000 # in meters
max_trip_duration <- 120 # in minutes
departure_datetime <- as.POSIXct("13-05-2019 14:00:00",
                                 format = "%d-%m-%Y %H:%M:%S")

time_window <- 120 # in minutes
percentiles <- c(20, 40, 60, 80, 99)

# calculate travel time matrix
ttm <- travel_time_matrix(r5r_core,
                          origins = points,
                          destinations = points,
                          mode = mode,
                          departure_datetime = departure_datetime,
                          max_walk_dist = max_walk_dist,
                          max_trip_duration = max_trip_duration,
                          time_window = time_window,
                          percentiles = percentiles,
                          verbose = FALSE)

head(ttm)
```

#### Visualizing travel-time uncertainty

<!-- In the example above we calculated how the estimates of travel-time to arrive at the central bus station vary by place of trip origin.  -->

The plot below shows how the travel times to arrive at the central bus station from several origin points vary within the time window (percentiles 20th, 40th, 60th, 80th, 99th), reflecting that these travel times are more uncertain when leaving from some places than others. While there is little to no uncertainty when departing from places that are very close (walking distance) to the central bus station, travel times from farther away places are more affected by variations departure time and service frequency levels.

```{r, message = FALSE}
# subset travel time matrix departing from a given origin
central_bus_stn <- points[291,]
ttm_tw <- subset(ttm, toId %in% central_bus_stn$id)

# reshape data
plot_data <- melt(ttm_tw, measure = patterns("^travel_time_p"), variable = "percentile", value = "travel_time")
plot_data[, mediantt := as.integer(median(travel_time, na.rm=T)), by=fromId]

ggplot(data=plot_data, aes(y = travel_time, x = reorder(fromId, mediantt))) +
  geom_point(alpha = 0.1, size = .7) +
  geom_line(aes(y=mediantt, group=toId), color="#FE9F45", size=1.5) +
  expand_limits(y = 120) +
  scale_y_continuous(breaks = c(0, 30, 60, 90, 120)) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks = element_blank(),
        panel.border = element_rect(fill = NA, colour = "grey80", size=1)) +
  labs(title = "Travel time uncertainty per destination",
       y = "Travel Time (min)", x='Origins ordered by median travel time')
```

#### Visualizing Isochrones

<!-- If the destination points cover the entire study area, the output can easily be used to build ishochrone-like visualizations.  -->

In our example, we can visualize the isochrone departing from the central bus station as follows:

```{r}
# extract OSM network
street_net <- street_network_to_sf(r5r_core)

travel_times <- ttm[fromId %in% central_bus_stn$id]
travel_times[points, on=c('toId' ='id'), `:=`(lon = i.lon, lat = i.lat)]
travel_times[, mediantt := median(travel_time_p020, travel_time_p040, 
                                  travel_time_p060, travel_time_p080,
                                  travel_time_p099), by = toId]
 
travel_times.interp <- with(travel_times, interp(lon, lat, mediantt)) %>%
                        with(cbind(travel_time=as.vector(z),  # Column-major order
                                   x=rep(x, times=length(y)),
                                   y=rep(y, each=length(x)))) %>% as.data.frame()

ggplot(na.omit(travel_times.interp)) +
  geom_contour_filled(aes(x=x, y=y, z=travel_time), alpha=.8) +
  geom_sf(data = street_net$edges, color = "gray55", size=0.1, alpha = 0.7) +
  scale_fill_viridis_d(direction = -1, option = 'B') +
  coord_sf() +
  labs(fill = "cutoff in minutes") +
  theme_minimal() +
  theme(axis.title = element_blank())
  
```

# Acknowledgments

The [R<sup>5</sup>](https://github.com/conveyal/r5) routing engine is developed at [Conveyal](https://www.conveyal.com/) with contributions from several developers. This work was supported by the Brazilian Institute for Applied Economic Research (Ipea).

# References

```{=html}
<!-- old isochrone code
# ```{r}
# cutoffs <- seq(0, 120, 20)
# 
# # select the travel time matrix departing from a given origin
# central_bus_stn <- points[291,]
# ttm_iso <- ttm[fromId %in% central_bus_stn$id ] 
# 
# # aggregate travel-times
# ttm_iso[, isochrones := cut(x=travel_time_p099, breaks=cutoffs), by= fromId]
#   
# # join travel-matrix results to points
# ttm_iso[points, on=c('toId' ='id'), `:=`(lon = i.lon, lat = i.lat)]
# 
# ggplot(ttm_iso, aes(x=lon, y=lat, colour = isochrones)) +
#    geom_point(size = 2) +
#    geom_point(data = central_bus_stn, aes(x=lon, y=lat), colour="blue", size = 2) +
#    coord_map() +
#    scale_colour_brewer(palette = "Reds") +
#    facet_wrap(~fromId) +
#    theme_minimal() +
#    theme(axis.title = element_blank(),
#          panel.border = element_rect(fill = NA, colour = "grey40"))
# ```
 -->
```
