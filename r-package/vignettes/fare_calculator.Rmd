---
title: 'Configuring and Using Fare Calculators'
author: "Rafael H. M. Pereira, Marcus Saraiva, Daniel Herszenhut, Carlos Kaue Braga, Matthew Wigginton Conway"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
abstract: "This vignette shows how to configure and use custom fare calculators in travel times and accessibility estimations in the `r5r` package."
urlcolor: blue
vignette: >
  %\VignetteIndexEntry{Configuring and Using Fare Calculators} 
  %\VignetteEngine{knitr::rmarkdown} 
  \usepackage[utf8]{inputenc}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r message=FALSE, include=FALSE}
options(java.parameters = "-Xmx2G")

library(r5r)
library(tidyverse)
library(sf)
library(data.table)
library(ggplot2)
library(dplyr)
library(mapview)
```

```{r}
# system.file returns the directory with example data inside the r5r package
# set data path to directory containing your own data if not using the examples
data_path <- system.file("extdata/poa", package = "r5r")

r5r_core <- setup_r5(data_path, verbose = FALSE)
```

## Introduction

Considering monetary costs of public transport in travel times and accessibility estimation is a challenge for researchers and planning practitioners. Each public transport system can have its own set of rules for calculating fares, with varying levels of complexity. Fare systems can have features such as: different costs for each leg of travel, depending on transport mode or route; distance- or zone-based fares; different fares for types of riders or time of the day (peak and off-peak, for example); among many others. One common feature among many public transport services is the possibility of integration between modes, when users can get use a single ticket for trip composed of multiple rides. Such trips usually come with a discount in the second or subsequent fares, as well as a limit on the number of discounted rides the user can take and/or a time limit for using that discount. As such, taking all those possible rules into consideration when calculating the monetary cost of multi-modal trips alongside travel times can be quite difficult.

The GTFS format has some features for specifying public transport fares, but those features are quite limited and are not enough for adequately representing many use cases. A new version of that specification is currently being developed (Fares V2 link), but it may take some time for it to be approved and for transport agencies actually start providing GTFS feeds with full fare information.

Meanwhile, R5 has native capabilities and an open architecture for creating and including fare calculators in travel time estimation, making it possible to estimate accessibility considering simultaneously travel time and monetary cost cutoffs. The main challenge, however, is that a specific fare calculator for each city needs to be programmed in Java and tightly integrated into R5. Thus, this is out of reach of many researchers and planners who use R5 through r5r.

To begin tackling this challenge, we are proposing a simple generic rule-based fare calculator that can be configured via a predefined set of properties and rules that can be set directly from R or using external tools such as text editors and spreadsheets. By no means we intend for this to be a robust system that can take into consideration all public transport systems out there. That would be a Herculean task, as can be seen by the long discussions taking place in the Fares V2 forums. The features included in r5r's fare calculator are inspired by our empirical observations of Brazilian public transport systems, and is meant to be used mainly in the (Access to Opportunities project)[https://www.ipea.gov.br/acessooportunidades/en/]. Everyone else is welcome to use it, if the current features suits their needs.

This vignette aims to show the features of the r5r fare calculator and to demonstrate how to configure it for a specific case. We will be using the sample data set for the city of Porto Alegre (Brazil) included in `r5r`.

## The public transport system of Porto Alegre

Porto Alegre has a relatively straightforward public transport system, where the vast majority of the population that rely on transit use buses. The city also has a metropolitan rail service that connects the city center to the neighboring municipalities in the North. That system can be seen in the map below.

```{r}
transit_network <- transit_network_to_sf(r5r_core)

mapview(transit_network$routes, zcol = "mode")
```

The fare rules in the system are as follows:

-   Each bus ticket costs R\$ 4.80.
-   Riding a second bus adds R\$ 2.40 to the total cost. Subsequent bus rides cost the full ticket price of R\$ 4.80.
-   Each train ticket costs R\$ 4.50. Once the user enters a train station, they can take an unlimited amount of trains as long as they do not leave the station.
-   The integrated tariff between bus and train has a 10% discount, which totals R\$ 8.37.

In the following sections, we will demonstrate how to implement those rules within r5r's fare calculator.

## Setting up the fare calculator

Three utility functions were added to r5r to allow configuring the fare calculator:

-   `setup_fare_calculator()`: analyses the study area's GTFS and builds a 'skeleton' structure of the parameters that need to be set;
-   `write_fare_calculator()` and `read_fare_calculator()`: allow saving the current fare calculator settings to disk, and reading them back into memory. The saved settings can be edited outside the R session using external text editors and spreadsheet software, for user's convenience.

First, we need to call `setup_fare_calculator()`, providing three parameters: the current `r5r_core` object, a `base_fare` that represents the default cost of trips that don't fall into the available categories, and the `by` parameters that identifies what is the main property of the route that defines the different fares.

In the example below, the `base_fare` is the standard bus ticket price of R\$ 4.80. Prices, however, must be represented as integer values, so here we are saying that the `base_fare` is equivalent to 480 cents. We are also stating that `by = "MODE"`, so that each transport mode has its own fares and integration rules. `by` can also be set to `"AGENCY_ID"` and `"AGENCY_NAME"`, so different rules can be applied to routes ran by different agencies, and to `"GENERIC"` when the entire system follows the same rules.

```{r}
fare_settings <- setup_fare_calculator(r5r_core, 
                                       base_fare = 4.8,
                                       by = "MODE")
```

Now let's check the contents of the `fare_settings` object. We can see below that it is simply a list with a few properties and data.frames.

```{r}
fare_settings
```

### Global Properties

Let's configure the global properties first, which are the ones that are applied to the entire system. First, we can see that `base_fare` has already been configured to 480, so we leave it as that. `max_discounted_transfers` is set to 1 by default, meaning that the traveler can get 1 integrated discount when riding multiple buses, but after that tickets are charged at full price. Finally, `transfer_time_allowance` is set to 120 minutes, so we have to set it to 60 minutes to fit our use case (travelers have 60 minutes to take the second bus on a discounted fare, otherwise a full fare is charged).

```{r}
fare_settings$base_fare
fare_settings$max_discounted_transfers
fare_settings$transfer_time_allowance <- 60
fare_settings$fare_cap
```

### Transport mode fares configuration

To configure mode-, transfer-, and route-specific properties, we can use the three data.frames inside `fare_settings`. Let's configure the modes first. Below, we can see that the `fare_per_mode` data.frame contains four columns:

-   mode: the transport mode to which rules on each row refer to;
-   unlimited_transfers: a boolean value that indicates if that transport mode allows unlimited transfers within itself, such as a metro/subway system where the user pays a fare to access a station and then can use as many services as they want as long as they don't exit the system.
-   use_route_fare: another boolean value that indicates if each route will have its own fare, or if all routes in this mode will use the fare indicated in this table.
-   fare: the full price fare of this mode.

```{r}
fare_settings$fares_per_mode
```

We need to do two small changes in the `fare_per_mode` table, specifically in the `"RAIL"` mode: setting `unlimited_transfers` to `TRUE`, and updating fare to 450. We also need to change one setting in the `"BUS"` mode. There is a discount for transfer between buses (which is set in the following section), but that discount is not valid when transferring between buses within the same route (for example, from bus T1 to another T1). We can use the `allow_same_route_transfer` parameter of the `"BUS"` mode for that. We'll do those changes below, using data.table notation.

```{r}
fare_settings$fares_per_mode[mode == "RAIL", unlimited_transfers := TRUE]
fare_settings$fares_per_mode[mode == "RAIL", fare := 4.5]
fare_settings$fares_per_mode[mode == "BUS", allow_same_route_transfer := FALSE]
```

Checking the results below, everything looks OK:

```{r}
fare_settings$fares_per_mode
```

### Transfer fares configuration

Transfer fares settings are stored in the `fare_per_transfer` data.frame, which is shown below. Each row contains information on how integration between the modes specified in `leg1` and `leg2` work.

```{r}
fare_settings$fares_per_transfer
```

Let's update `fare_per_transfer` to account for the actual integration rules in Porto Alegre.

-   The fare for "BUS" to "BUS" integration is composed of 480 for the first leg plus 240 for the second leg, which equals to a total fare of 720.

```{r}
fare_settings$fares_per_transfer[first_leg == "BUS" & second_leg == "BUS", 
                                fare := 7.2]
```

-   Transfers between "RAIL" and "RAIL" are free and unlimited, which is already accounted for in the field `unlimited_transfers` of the `fare_per_mode` table. Thus, the equivalent row of the `fare_per_transfer` data.frame needs to be removed. If we leave the that row in `fare_per_transfer`, transfers between "RAIL" and "RAIL" will count to the global `max_discounted_transfers` allowance.

```{r}
fare_settings$fares_per_transfer <- 
  fare_settings$fares_per_transfer[!(first_leg == "RAIL" & second_leg == "RAIL")]
```

- Transfers between "BUS" and "RAIL" (in any direction) cost 837, once the 10% discount is applied. Also, `allow_same_route` is irrelevant here, because those transfers are necessarily between different routes. Let's make a final update in the data.frame to account for that.

```{r}
fare_settings$fares_per_transfer[first_leg != second_leg, fare := 8.37]
```

Once all changes are applied, the `fare_per_transfer` data.frame should look like this:

```{r}
fare_settings$fares_per_transfer
```

### Routes configuration

Information on specific routes is stored in the `routes_info` data.frame. Below, we can see a sample of the bus and train routes in Porto Alegre.

```{r}
tail(fare_settings$fares_per_route)
```

Basic route information is taken directly from the GTFS data (agency, route id and names, mode, etc), but `route_fare` and `fare_type` columns were added specifically for the fare calculator.

-   `route_fare`: is used to set a specific fare for each route. This field can be used to represent services that have many unique fares, such as metropolitan / suburban trains and buses. This is used together with the `use_route_fare` column in the `fare_per_mode` table: the `route_fare` field is only read by the fare_calculator when `use_route_fare` of that mode is set to TRUE.

-   `fare_type`: is used to link each route with information in the `fare_per_mode` and `fare_per_transfer` tables. In this example, `fare_type` is always the same as `mode`, because that was what we choose when calling `setup_fare_calculator` earlier (we could have chosen to discriminate fares by agency, for example).

We actually don't have any change do to in the `routes_info` table, in this example. It does not matter that the `route_fare` value is wrong for the "RAIL" lines, because we are using the fares set in `fare_per_mode` and `fare_per_transfer` which we already set up correctly before.

Now that our `fare_settings` is complete, we can use it to calculate accessibility with monetary cost cutoffs. Let's see how it's done in the next section.

## Calculating accessibiilty with monetary cost

The `travel_time_matrix()` and `accessibility()` functions have two new parameters to account for monetary costs thresholds:

-   `fare_calculator_settings`: the settings object that we've been working on.
-   `max_fare`: the maximum total fare that can be used in the trip.

Now, we can answer questions like "how many jobs one can access in 60 minutes using public transport, on a \$5 budget?".

```{r}
points_small <- read.csv(system.file("extdata/poa/poa_hexgrid.csv", 
                                     package = "r5r"))
points_small$unit <- 1
departure_datetime <- as.POSIXct("13-05-2019 14:00:00", 
                                 format = "%d-%m-%Y %H:%M:%S")


# helper function to calculate accessibility with common settings
calculate_accessibility <- function(settings, fare) {
  
  if (!is.null(settings)) {
    settings$debug_settings$output_file = 
      here::here("tests_marcus", paste0("debug_fare_", fare, ".csv" ))
  }

  # if (!is.null(settings)) {
  #   debug_file <- here::here("tests_marcus/debug_poa", 
  #                            )
  #   settings$debug_settings$output_file = debug_file
  # }
  
  access_df <- accessibility(r5r_core,
                        origins = points_small,
                        destinations = points_small,
                        departure_datetime = departure_datetime,
                        opportunities_colname = "unit",
                        mode = c("WALK", "TRANSIT"),
                        cutoffs = c(60),
                        fare_calculator_settings = settings,
                        max_fare = fare,
                        max_trip_duration = 60,
                        max_walk_dist = 800,
                        time_window = 1,
                        percentiles = 50,
                        verbose = FALSE)
}
```

```{r}
fare_settings2 <- fare_settings
fare_settings2$fares_per_transfer <- data.table::data.table()
```


```{r}
access_unl <- calculate_accessibility(NULL, 0)
access_300 <- calculate_accessibility(fare_settings, 3.00)
access_500 <- calculate_accessibility(fare_settings, 5.00)
access_900 <- calculate_accessibility(fare_settings, 9.00)
```

```{r}
clipr::write_clip(r5r_core$getFareStructure())
clipr::write_clip(r5r_core$getFareCalculatorDebugOutputSettings())
r5r_core$setFareCalculatorDebugOutputSettings(here::here("tests_marcus", "dbg2.csv"),
                                              "MODE")
```


```{r}
access_unl$max_fare <- "unl"
access_300$max_fare <- "3.0"
access_500$max_fare <- "5.0"
access_900$max_fare <- "9.0"

access_df <- rbind(access_unl, access_300, access_500, access_900)
```

```{r}
access_df$geometry <- h3jsr::h3_to_polygon(access_df$from_id)
access_df <- st_as_sf(access_df, crs = 4326)
```

```{r}
access_df %>%
  filter(cutoff == 60) %>%
  ggplot() +
  geom_sf(aes(fill=accessibility), color = NA) +
  scale_fill_distiller(palette = "Spectral") +
  facet_wrap(~max_fare)
```

```{r}
debug_df <- read_csv(here::here("tests_marcus/debug_poa", "debug_fare_300.csv"))
debug_df <- read_csv(here::here("tests_marcus/debug_poa", "debug_fare_500.csv"))
debug_df <- read_csv(here::here("tests_marcus/debug_poa", "debug_fare_900.csv"))
```

```{r}
access_df %>%
  st_set_geometry(NULL) %>%
  pivot_wider(names_from = max_fare, values_from = accessibility) %>%
  janitor::clean_names()
```

```{r}
write_fare_calculator(fare_settings, file_path = here::here("teste_fares_poa.zip"))
fare_settings_2 <- read_fare_calculator(file_path = here::here("teste_fares_poa.zip"))
```


